<!DOCTYPE html>
<html>
<meta charset="utf-8" />

<title>WebSocket Test</title>

<script language="javascript" type="text/javascript">

  var ip = location.host;
  var CamUri = "ws://" + ip + "/ws";
  //var KeyUri = "ws://" + ip.replace("8888") + "/ws";
  var output;
  //var cam_socket;
  //var key_socket;
  //var vid;
  let loaded = true
  let size  = 0
  var ws = new WebSocket("ws://10.151.170.5:8888/websocket");
  // ws.onmessage = function(evt){
  //     x = document.createElement("p");
  //     document.getElementById("button").appendChild(x);
  // }
  // function DispatchText(){
  //     if (document.getElementById("day1").checked) {
  //         var data = ["10", "20", "30", "40"];
  //         {{ drawPie(["10", "20", "30", "40"]) }};
  //     }
  // }


  const reloadImg = url =>
  fetch(url, { cache: 'no-cache', mode: 'no-cors' })
  .then(response => {
    console.log('fetch ', response)
    //document.body.querySelectorAll('img[src="${url}"]').forEach(img => img.src = url)
    document.getElementById("preview").src=response.url+"?d="+Date.now();
    loaded = true
    sendCommand()
  }
  )

  function init()
  {
    // output = document.getElementById("output");
    // vid = document.createElement("video");
    // vid_src = document.createElement("source");
    // vid.width = 1280;
    // vid.height = 720;
    // vid_src.src = CamUri;
    // vid.appendChild(vid_src)
    // output.appendChild(vid);
    //testWebSocket();
    //window.setTimeout(sendCommandVector, 1000);
    //console.log('init')
    updateImage();
  }

  function sendCommand() {
    if (cam_socket.readyState == 1) {

      console.log("SENDING");
      if(size == 0){
        size = 1
        cam_socket.send(JSON.stringify('large'));
      }else{
        cam_socket.send(JSON.stringify('small'));
        size = 0
      }
    }else {
      console.log("CONNECTION FAILED");
    }

    // if (key_socket.readyState == 1) {
    //   console.log("SENDING");
    //   key_socket.send(JSON.stringify(vector));
    //   window.setTimeout(sendCommandVector, 100);
    // } else {
    //   console.log("CONNECTION FAILED");
    // }
  }

  function testWebSocket()
  {
    cam_socket = new WebSocket(CamUri);
    cam_socket.onopen = function(evt) { onOpen(evt) };
    cam_socket.onclose = function(evt) { onClose(evt) };
    cam_socket.onmessage = function(evt) { onMessage(evt) };
    cam_socket.onerror = function(evt) { onError(evt) };

    // key_socket = new WebSocket(KeyUri);
    // key_socket.on_open = function(evt) {
    //   console.log("Command link established.");
    // }
    // key_socket.on_error = function(evt) {
    //   console.log("Command error");
    // }
    // key_socket.on_close = function(evt) {
    //   console.log("Command link lost");
    // }
  }

  function onOpen(evt)
  {
    writeToScreen("WS CONNECTED");
  }

  function onClose(evt)
  {
    writeToScreen("WS DISCONNECTED");
  }

  function onMessage(evt)
  {
    // var outDiv = document.getElementById("output");
    // var image = evt.data;
    // var imageURL = URL.createObjectURL(image);

    // img.src = imageURL;

    // img.onload = function(e) {
    //     window.URL.revokeObjectURL(this.imageURL);
    // }

    //console.log(evt.data);
  }

  function onError(evt)
  {
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
  }

  function writeToScreen(message)
  {
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
  }

  function updateImage()
  {
      //console.log('update image')
      if(loaded){
        loaded = false
        reloadImg('preview.jpg')
      }

      setTimeout(updateImage, 1000);
  }
  updateImage();
  window.addEventListener("load", init, false);
 
</script>
<body>
<h2>WebSocket Test</h2>
<p><input type="submit" class="button" name="basic" value="Basic Query"></p>
<p><input type="submit" class="button" name="advanced" value="Advanced Query"></p>
<div id="output"><img id="preview" src=""/></div>
</body>

</html>
